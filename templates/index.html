{% extends "base.html" %}

{% block title %}All Bets{% endblock %}

{% block content %}
    <h1>Bet Overview</h1>

    <h2>Active Bets</h2>
    {% if bet_data|selectattr("bet.resolved", "equalto", false)|list %}
        {% for item in bet_data if not item.bet.resolved %}
            <div class="bet-card">
                <h3>{{ item.bet.title }} <span class="badge bg-success">Active</span></h3>
                <p>{{ item.bet.description }}</p>
                <p><small>Created by: {{ item.bet.creator.name }} | Expires: {{ item.bet.expiration_date.strftime('%Y-%m-%d %H:%M') }}</small></p>
                <p><small>Participants ({{ item.total_bets_on_this_bet }}): {{ item.users_who_betted|join(', ') if item.users_who_betted else 'None yet' }}</small></p>

                <h4>Outcomes & Probabilities:</h4>
                {% for outcome in item.bet.get_outcomes_list() %}
                    <div>
                        <strong>{{ outcome }}</strong>: {{ "%.2f"|format(item.outcome_percentages[outcome]) }}%
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: {{ item.outcome_percentages[outcome] }}%;" aria-valuenow="{{ item.outcome_percentages[outcome] }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                {% endfor %}

                {% if current_user.is_authenticated %}
                    {% if not item.bet.resolved and item.bet.expiration_date > current_server_time %}
                        {% set user_has_bet = false %}
                        {% for ub in item.bet.user_bets %}
                            {% if ub.user_id == current_user.id %}
                                {% set user_has_bet = true %}
                            {% endif %}
                        {% endfor %}

                        {% if not user_has_bet %}
                            <form method="POST" action="{{ url_for('place_bet', bet_id=item.bet.id) }}" class="mt-3">
                                <div class="mb-3">
                                    <label for="chosen_outcome_{{item.bet.id}}" class="form-label">Place Your Bet:</label>
                                    <select name="chosen_outcome" id="chosen_outcome_{{item.bet.id}}" class="form-select">
                                        {% for outcome in item.bet.get_outcomes_list() %}
                                            <option value="{{ outcome }}">{{ outcome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Submit Bet</button>
                            </form>
                        {% else %}
                            <p class="mt-3"><small><em>You have already placed a bet on this item. Your choice: 
                                {% for ub in item.bet.user_bets %}
                                    {% if ub.user_id == current_user.id %}
                                        {{ ub.chosen_outcome }}
                                    {% endif %}
                                {% endfor %}
                            </em></small></p>
                        {% endif %}
                    {% elif item.bet.expiration_date <= current_server_time and not item.bet.resolved %}
                         <p class="mt-3"><span class="badge bg-warning text-dark">Expired - Awaiting Resolution</span></p>
                    {% endif %}

                    {% if item.bet.creator_id == current_user.id and not item.bet.resolved %}
                        <form method="POST" action="{{ url_for('resolve_bet', bet_id=item.bet.id) }}" class="mt-3">
                            <div class="mb-3">
                                <label for="winning_outcome_{{item.bet.id}}" class="form-label">Resolve Bet (Select Winning Outcome):</label>
                                <select name="winning_outcome" id="winning_outcome_{{item.bet.id}}" class="form-select">
                                    {% for outcome in item.bet.get_outcomes_list() %}
                                        <option value="{{ outcome }}">{{ outcome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-info btn-sm">Resolve Bet</button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    {% else %}
        <p>No active bets at the moment.</p>
    {% endif %}

    <hr class="my-4">

    <h2>Resolved Bets</h2>
    {% if bet_data|selectattr("bet.resolved", "equalto", true)|list %}
        {% for item in bet_data if item.bet.resolved %}
            <div class="bet-card">
                <h3>{{ item.bet.title }} <span class="badge bg-secondary">Resolved</span></h3>
                <p>{{ item.bet.description }}</p>
                <p><small>Created by: {{ item.bet.creator.name }} | Expired: {{ item.bet.expiration_date.strftime('%Y-%m-%d %H:%M') }}</small></p>
                <p><strong>Winning Outcome: <span class="text-success fw-bold">{{ item.bet.winning_outcome }}</span></strong></p>
                
                <h4>Participants & Results:</h4>
                {% if item.bet.user_bets.all() %}
                    <ul class="list-group list-group-flush mb-3">
                        {% for user_bet_detail in item.bet.user_bets %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ user_bet_detail.user.name }} chose: {{ user_bet_detail.chosen_outcome }}
                                {% if user_bet_detail.chosen_outcome == item.bet.winning_outcome %}
                                    <span class="badge bg-success rounded-pill">Won</span>
                                {% else %}
                                    <span class="badge bg-danger rounded-pill">Lost</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p><small>No participants in this bet.</small></p>
                {% endif %}

                <h4>Final Outcome Distribution:</h4>
                {% for outcome in item.bet.get_outcomes_list() %}
                    <div>
                        <strong>{{ outcome }}</strong>: {{ "%.2f"|format(item.outcome_percentages[outcome]) }}%
                        <div class="progress">
                            <div class="progress-bar {% if outcome == item.bet.winning_outcome %}bg-success{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ item.outcome_percentages[outcome] }}%;" aria-valuenow="{{ item.outcome_percentages[outcome] }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    {% else %}
        <p>No resolved bets yet.</p>
    {% endif %}

{% endblock %} 